import { WritableStreamBuffer } from 'stream-buffers';

import { createLogger } from './logger';
import pollLogger from './poll-logger';

describe('stackdriver formatting', () => {
  it('removes the "time" field', async () => {
    const stream = new WritableStreamBuffer();
    const logger = createLogger({ level: 'info' }, stream);
    logger.info('hello world');

    const output = await pollLogger(stream);

    expect(output?.[0].severity).toEqual('INFO');
    expect(output?.[0].message).toEqual('hello world');
    expect(output?.[0].time).not.toBeDefined();
  });

  it('adds request fields as labels', async () => {
    const stream = new WritableStreamBuffer();
    const logger = createLogger({ level: 'info' }, stream);
    logger.info('hello world');

    const output = await pollLogger(stream);

    expect(output?.[0].severity).toEqual('INFO');
    expect(output?.[0].message).toEqual('hello world');
    expect(output?.[0].time).not.toBeDefined();
  });
});
