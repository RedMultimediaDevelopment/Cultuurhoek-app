import { WritableStreamBuffer } from 'stream-buffers';

// used in tests to allow us to check test output
export default async function pollForLoggerData(
  stream: WritableStreamBuffer
): Promise<any[]> {
  let elapsedTime = 0;
  let value: any | null = null;
  const incrementInMs = 50;
  const maxTime = 1000;

  while (!value && elapsedTime < maxTime) {
    await new Promise(function (resolve, reject) {
      setTimeout(function () {
        resolve({});
      }, incrementInMs);
    });
    const currentVal = stream.getContentsAsString('utf-8');
    if (currentVal) {
      value = currentVal
        .split('\n')
        .filter((line) => !!line)
        .map((line) => JSON.parse(line));
    }
    elapsedTime += incrementInMs;
  }

  return value || [];
}
