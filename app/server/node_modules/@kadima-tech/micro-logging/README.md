# @standinworks/micro-logging

Allows us to easily do structured http and standard logging inside node projects. Comes with built in loggers set up for:

- Arbitrary Logging
- Express integration
- Fastify integration

It's built on the fantastic [pino](https://github.com/pinojs/pino) logger.

This package is not responsible for shipping the logs to whatever system you choose it will only throw them out to stdout.

## Generalised logging

Sometimes you just want to log something and you don't have access to the req.logger object. In that case you can just directly access the logger:

```
import logger from '@standinworks/micro-logging';

logger.info("I am a nice message");
logger.error({ message: "you can also just pass json through", age: 100});
```

The api is intentionally similar to console, see [here](https://github.com/pinojs/pino/blob/master/docs/api.md) for more detail. As such you should use `logger.info` to replace `console.log`.

By default the general logger is set to the "info" logging level but this can be overriden by setting the `LOGGING_LEVEL` env var to one of:

- "fatal"
- "error"
- "warn"
- "info"
- "debug"
- "trace"

## Logging requests in express

We just need to add the http logger as middleware. In your express setup add something like the following:

```
import express from 'express';
import { expressLogger } from '@standinworks/micro-logging';

const app = express();
app.use(expressLogger);
```

The log level defaults to `info` and can be controlled via the `LOGGING_LEVEL_HTTP` environment variable and can be set to one of the following:

- "fatal" - would only log crashes
- "error" - would log 5xx requests
- "warn" - will log 5xx and 4xx requests, the default log level
- "info" - will log all requests
- "debug" - add extra debug info
- "trace" - log everything possible

this middleware will also add a req.logger property to the request which should be used for logging if possible as the request id will remain consistent across all your logs.

## Logging requests in fastify

Fastify already has pino integrated, we just want to tweak the settings a bit:

```
import fastify from 'fastify';
import { fastifyLogger, registerFastifyLoggingHooks } from '@standinworks/micro-logging';

const app = fastify({ logger: fastifyLogger });
registerFastifyLoggingHooks(app);
```

The log level defaults to `info` and can be controlled via the `LOGGING_LEVEL_HTTP` environment variable and can be set to one of the following:

- "fatal" - would only log crashes
- "error" - would log 5xx requests
- "warn" - will log 5xx and any associated warnings, the default log level
- "info" - will log all requests
- "debug" - add extra debug info
- "trace" - log everything possible

this middleware will also add a req.logger property to the request which should be used for logging if possible as the request id will remain consistent across all your logs.

## Redaction

Logging requests is kinda painful from a gdpr/personal data perspective. Currently the following keys are auto-redacted:

-- req.headers.authorization,
-- req.headers.cookie,
-- res.headers["set-cookie"],
-- requestBody.email,
-- responseBody.email,
-- responseBody.data.email,
-- responseBody.data.serviceAccess,

Request bodies are not logged by default so they shouldn't be an issue but please stick in a pr if you can think of any more.

When working locally you can disable redaction by setting the `LOGGING_DISABLE_REDACTION` env var to `true`

## Pretty printing

The default json output is not exactly readable. To fix this can set the env var `LOGGING_PRETTY` to `true`. You'll then get nice pretty logs when running locally

## Stackdriver compatibility

The standard pino output has been altered to be stackdriver compatible. You shouldn't need to do anything here.
